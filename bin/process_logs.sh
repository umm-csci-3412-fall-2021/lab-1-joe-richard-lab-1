#!/usr/bin/env bash

tempDir="$(mktemp -d)"

# For each tar file, extract it and aggregate its contents into a single file.
for tarFile in "$@"; do
  machineLogsDir="$tempDir"/"$(basename "$tarFile" .tgz)"
  mkdir "$machineLogsDir"
  tar -xzf "$tarFile" -C "$machineLogsDir"
  ./bin/process_client_logs.sh "$machineLogsDir"
done

# Count the frequency of failed login attempts by username, hour of day,
# and country of origin.
./bin/create_username_dist.sh "$tempDir"
./bin/create_hours_dist.sh "$tempDir"
./bin/create_country_dist.sh "$tempDir"
./bin/assemble_report.sh "$tempDir"

# Move the file generated by assemble_report.sh into our current directory.
mv "$tempDir"/failed_login_summary.html "$(pwd)"

rm -r "$tempDir"
